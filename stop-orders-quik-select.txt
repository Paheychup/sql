SELECT
CLIENT_CODE AS [ÊÎÄ ÊËÈÅÍÒÀ]
,CLASS_CODE AS [ÊÎÄ ÊËÀÑÑÀ]
,SEC_CODE AS [ÊÎÄ ÈÍÑÒÐÓÌÅÍÒÀ]
,VOLUME AS [ÊÎË-ÂÎ]
,STOP_ORDER_ID AS [ÍÎÌÅÐ]
,P.PERSON_LAST_NAME + ' ' + P.PERSON_FIRST_NAME AS [ÊÒÎ ÂÛÑÒÀÂÈË ÑÒÎÏ-ÇÀßÂÊÓ]
,U.USER_ID AS [UID]
--,*
FROM STOP_ORDERS SO (NOLOCK)
JOIN USERS U ON SO.USER_ID=U.USER_ID
JOIN PERSON P ON P.PERSON_ID=U.PERSON_ID
-- *** ÓÊÀÇÀÒÜ ÈÍÒÅÐÅÑÓÞÙÓÞ ÔÈÐÌÓ FIRM_ID=***
WHERE FIRM_ID='MC0139600000' AND SEC_CODE IN
(
-- *** ÍÅÎÁÕÎÄÈÌÎ ÓÊÀÇÀÒÜ ÈÍÒÅÐÅÑÓÞÙÈÅ ÊÎÄÛ ÈÍÑÒÐÓÌÅÍÒÎÂ SEC_CODE IN***
'UPRO'
)
 
AND CLASS_CODE IN (
-- *** ÍÅÎÁÕÎÄÈÌÎ ÓÊÀÇÀÒÜ ÈÍÒÅÐÅÑÓÞÙÈÅ ÊËÀÑÑÛ ÈÍÑÒÐÓÌÅÍÒÎÂ CLASS_CODE IN***
'TQBR'
)
AND STOP_ORDER_ID IN (SELECT STOP_ORDER_ID FROM STOP_ORDERS SO, USERS U
WHERE ( ( (SO.STATUS='N' OR SO.STATUS='F' OR SO.STATUS='Z' OR SO.STATUS='P') AND
(SO.EXPIRY_DATE >= CONVERT(DATETIME,CONVERT(CHAR(10),GETDATE(),102),102)
OR SO.EXPIRY_DATE IS NULL) ) OR
SO.KILL_TIME >= CONVERT(DATETIME,CONVERT(CHAR(10),GETDATE(),102),102) OR
SO.RUN_TIME >= CONVERT(DATETIME,CONVERT(CHAR(10),GETDATE(),102),102) )
AND
(SO.USER_ID=U.USER_ID AND U.DISABLED='N' AND U.MODE NOT LIKE '%%L%%' AND
U.END_DATE > CONVERT(DATETIME,CONVERT(CHAR(10),GETDATE(),102),102) AND
U.BEGIN_DATE <= CONVERT(DATETIME,CONVERT(CHAR(10),GETDATE(),102),102)))
  
ORDER BY CLIENT_CODE ,SEC_CODE,VOLUME DESC